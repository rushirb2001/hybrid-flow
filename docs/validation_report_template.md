# Neo4j Validation Report

**Date**: {{DATE}}
**Version**: {{VERSION_ID}}
**Generated By**: {{GENERATED_BY}}

## Executive Summary

- **Overall Status**: {{STATUS}}
- **Total Nodes**: {{TOTAL_NODES}}
- **Total Relationships**: {{TOTAL_RELATIONSHIPS}}
- **Issues Found**: {{ISSUES_COUNT}}

## Node Statistics

| Node Type | Count |
|-----------|-------|
| Textbook | {{TEXTBOOK_COUNT}} |
| Chapter | {{CHAPTER_COUNT}} |
| Section | {{SECTION_COUNT}} |
| Subsection | {{SUBSECTION_COUNT}} |
| Subsubsection | {{SUBSUBSECTION_COUNT}} |
| Paragraph | {{PARAGRAPH_COUNT}} |
| Table | {{TABLE_COUNT}} |
| Figure | {{FIGURE_COUNT}} |

**Total Nodes**: {{TOTAL_NODES}}

## Relationship Statistics

| Relationship Type | Count |
|-------------------|-------|
| CONTAINS | {{CONTAINS_COUNT}} |
| HAS_SECTION | {{HAS_SECTION_COUNT}} |
| HAS_SUBSECTION | {{HAS_SUBSECTION_COUNT}} |
| HAS_SUBSUBSECTION | {{HAS_SUBSUBSECTION_COUNT}} |
| HAS_PARAGRAPH | {{HAS_PARAGRAPH_COUNT}} |
| NEXT | {{NEXT_COUNT}} |
| PREV | {{PREV_COUNT}} |
| CONTAINS_TABLE | {{CONTAINS_TABLE_COUNT}} |
| CONTAINS_FIGURE | {{CONTAINS_FIGURE_COUNT}} |

**Total Relationships**: {{TOTAL_RELATIONSHIPS}}

## Data Integrity Checks

### ✓ Orphan Node Detection
- **Orphan Paragraphs**: {{ORPHAN_PARAGRAPHS}}
- **Status**: {{ORPHAN_STATUS}}
- **Details**: {{ORPHAN_DETAILS}}

### ✓ Relationship Chain Integrity
- **Broken NEXT Chains**: {{BROKEN_NEXT}}
- **Broken PREV Chains**: {{BROKEN_PREV}}
- **Status**: {{CHAIN_STATUS}}
- **Details**: {{CHAIN_DETAILS}}

### ✓ Duplicate Detection
- **Duplicate Chunk IDs**: {{DUPLICATE_CHUNK_IDS}}
- **Status**: {{DUPLICATE_STATUS}}
- **Details**: {{DUPLICATE_DETAILS}}

### ✓ Hierarchy Validation
- **Invalid Hierarchies**: {{INVALID_HIERARCHIES}}
- **Status**: {{HIERARCHY_STATUS}}
- **Details**: {{HIERARCHY_DETAILS}}

## Text Content Statistics

| Metric | Value |
|--------|-------|
| Average Text Length | {{AVG_TEXT_LENGTH}} characters |
| Minimum Text Length | {{MIN_TEXT_LENGTH}} characters |
| Maximum Text Length | {{MAX_TEXT_LENGTH}} characters |

## Chapter Distribution

### Top 10 Chapters by Paragraph Count

| Rank | Chapter | Paragraph Count |
|------|---------|-----------------|
{{#TOP_CHAPTERS}}
| {{RANK}} | {{CHAPTER}} | {{PARAGRAPH_COUNT}} |
{{/TOP_CHAPTERS}}

## Cross-References

- **Paragraphs with Cross-References**: {{PARAGRAPHS_WITH_REFS}}
- **Percentage**: {{REFS_PERCENTAGE}}%

## Database Consistency (Neo4j vs Qdrant)

{{#QDRANT_COMPARISON}}
| Metric | Value |
|--------|-------|
| Neo4j Paragraph Count | {{NEO4J_COUNT}} |
| Qdrant Vector Count | {{QDRANT_COUNT}} |
| Common (In Both) | {{COMMON_COUNT}} |
| Only in Neo4j | {{ONLY_NEO4J}} |
| Only in Qdrant | {{ONLY_QDRANT}} |
| **Consistency Status** | **{{CONSISTENCY_STATUS}}** |

### Mismatches (if any)

**Sample chunks only in Neo4j**:
{{SAMPLE_ONLY_NEO4J}}

**Sample chunks only in Qdrant**:
{{SAMPLE_ONLY_QDRANT}}
{{/QDRANT_COMPARISON}}

## Issues Summary

{{#ISSUES}}
### {{ISSUE_TYPE}}
- **Severity**: {{SEVERITY}}
- **Count**: {{COUNT}}
- **Description**: {{DESCRIPTION}}
- **Recommended Action**: {{ACTION}}
{{/ISSUES}}

{{#NO_ISSUES}}
✅ **No issues detected** - Graph validation passed all checks.
{{/NO_ISSUES}}

## Recommendations

{{#RECOMMENDATIONS}}
- {{RECOMMENDATION}}
{{/RECOMMENDATIONS}}

## Validation Criteria

### Passing Criteria
- ✓ Orphan paragraphs = 0
- ✓ Broken NEXT chains = 0
- ✓ Broken PREV chains = 0
- ✓ Duplicate chunk_ids = 0
- ✓ Invalid hierarchies = 0
- ✓ Neo4j count = Qdrant count (if Qdrant comparison performed)

### Current Status
**{{OVERALL_STATUS_DESCRIPTION}}**

---

## Raw Validation Data

```json
{{RAW_VALIDATION_JSON}}
```

---

## Appendix: Validation Commands

### Generate This Report
```bash
poetry run python -c "
from src.hybridflow.storage.neo4j_client import Neo4jStorage
import os, json
from dotenv import load_dotenv
load_dotenv()
storage = Neo4jStorage(uri=os.getenv('NEO4J_URI'), user=os.getenv('NEO4J_USER'), password=os.getenv('NEO4J_PASSWORD'))
report = storage.get_graph_stats('{{VERSION_ID}}')
print(json.dumps(report, indent=2))
"
```

### Validate Specific Version
```bash
poetry run python -c "
from src.hybridflow.storage.neo4j_client import Neo4jStorage
import os
from dotenv import load_dotenv
load_dotenv()
storage = Neo4jStorage(uri=os.getenv('NEO4J_URI'), user=os.getenv('NEO4J_USER'), password=os.getenv('NEO4J_PASSWORD'))
report = storage.validate_graph('{{VERSION_ID}}')
print(f\"Status: {report['status']}\")
"
```

### Compare with Qdrant
```bash
poetry run python -c "
from src.hybridflow.storage.neo4j_client import Neo4jStorage
from qdrant_client import QdrantClient
import os
from dotenv import load_dotenv
load_dotenv()

# Get all Qdrant chunk_ids
qclient = QdrantClient(host='localhost', port=6333)
chunk_ids = set()
offset = None
while True:
    result, offset = qclient.scroll('textbook_chunks', limit=1000, offset=offset, with_payload=True)
    if not result:
        break
    chunk_ids.update(p.payload.get('chunk_id') for p in result if p.payload.get('chunk_id'))
    if offset is None:
        break

# Compare with Neo4j
storage = Neo4jStorage(uri=os.getenv('NEO4J_URI'), user=os.getenv('NEO4J_USER'), password=os.getenv('NEO4J_PASSWORD'))
comparison = storage.compare_with_qdrant(chunk_ids, '{{VERSION_ID}}')
print(f\"Consistency: {comparison['consistency']}\")
"
```

---

**Report End**
